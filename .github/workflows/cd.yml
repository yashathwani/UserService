name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
env:
  KUBECONFIG: /home/ubuntu/.kube/config

jobs:
  deploy:
    name: Deploy to K8s
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check K8s Connectivity
        run: |
          kubectl --kubeconfig /home/ubuntu/.kube/config cluster-info
          kubectl --kubeconfig /home/ubuntu/.kube/config config current-context

      - name: Create Namespace
        run: kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/namespace.yaml

      - name: Deploy Application
        run: |
          echo "Applying Kubernetes manifests..."
          kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/namespace.yaml || true
          kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/deployment.yaml
          kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/service.yaml

          echo "Waiting for rollout to complete..."
          kubectl --kubeconfig /home/ubuntu/.kube/config rollout status deployment/userservice-deployment -n userservice-ns --timeout=300s

          echo "Checking pods and events after rollout attempt..."
          kubectl --kubeconfig /home/ubuntu/.kube/config get all -n userservice-ns
          kubectl --kubeconfig /home/ubuntu/.kube/config describe deployment userservice-deployment -n userservice-ns
          kubectl --kubeconfig /home/ubuntu/.kube/config get pods -n userservice-ns -o wide
          kubectl --kubeconfig /home/ubuntu/.kube/config describe pods -n userservice-ns | tail -n 100
          kubectl --kubeconfig /home/ubuntu/.kube/config get events -n userservice-ns --sort-by=.metadata.creationTimestamp | tail -n 20

  dast:
    name: Security Scan (DAST)
    needs: deploy
    runs-on: self-hosted
    steps:
      - name: Dummy ZAP Scan
        run: |
          echo "Running dummy DAST scan against http://localhost:30080"
          sleep 5
          echo "DAST scan completed. Status: Secure"
