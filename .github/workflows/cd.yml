name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
env:
  KUBECONFIG: /home/ubuntu/.kube/config

jobs:
  deploy:
    name: Deploy to K8s
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check K8s Connectivity
        run: |
          kubectl --kubeconfig /home/ubuntu/.kube/config cluster-info
          kubectl --kubeconfig /home/ubuntu/.kube/config config current-context

      - name: Create Namespace
        run: kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/namespace.yaml

      - name: Deploy Application
        run: |
          kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/deployment.yaml
          kubectl --kubeconfig /home/ubuntu/.kube/config apply -f k8s/service.yaml
          kubectl --kubeconfig /home/ubuntu/.kube/config rollout status deployment/userservice-deployment -n userservice-ns

  dast:
    name: Security Scan (DAST)
    needs: deploy
    runs-on: self-hosted
    steps:
      - name: Dummy ZAP Scan
        run: |
          echo "Running dummy DAST scan against http://localhost:30080"
          sleep 5
          echo "DAST scan completed. Status: Secure"
